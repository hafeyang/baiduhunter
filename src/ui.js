var ui=ui||{};ui.ArgumentTestRegex=/\?[\-\w]+=[\-\w]+/;ui.showCnt=function(a,c){var b,d="1";c=c||0;if(!c){top.frames["main-frame"].location.href=a}else{b=serviceTree.getCurrentNode();if(b){d=b.id}if(ui.ArgumentTestRegex.test(a)){top.frames["main-frame"].location.href=a+"&nodeId="+d+"&nodeid="+d}else{top.frames["main-frame"].location.href=a+"?nodeId="+d+"&nodeid="+d}}};ui.nodeChange=function(b){var c=top.frames["main-frame"],d=b.id,a=location.href.substring(location.href.indexOf("#")+1);if(!a){return false}if(a.indexOf("suid")!=-1){return false}else{if(a.indexOf("aos-web")!=-1&&(!/page=LaunchList\.ChooseSu/i.test(a)&&!/ViewServiceUnit/i.test(a))){return false}else{if(/tree_addnode\.html/i.test(a)){return false}else{if(a.indexOf("del=1")!=-1){return false}else{if(a.indexOf("ShowNodeInfo")!=-1){return false}else{url2=a.replace(/nodeid=(:|\w)*/g,"nodeid="+d);url2=url2.replace(/nodeId=(:|\w)*/g,"nodeId="+d);url2=url2.replace(/treeId=(:|\w)*/g,"treeId="+b.treeId||1);url2=url2.replace(/treeId=\d+/g,"treeId="+b.treeId||1);if(a!=url2){if(/\Wop_\w*=/i.test(url2)){url2=url2.replace(/&op_\w*=(\w)*/g,"");url2=url2.replace(/\?op_\w*=\w*&/g,"?");url2=url2.replace(/\?op_\w*=\w*$/g,"")}location.href="#"+url2}}}}}}if(typeof top.frames["main-frame"].treeCallback=="function"){top.rightFrame.treeCallback(b)}return true};ui.getNodeId=function(){var a=serviceTree.getCurrentNode();if(a){return a.id}else{return -1}};ui.getNodeAttributes=function(){var a=serviceTree.getCurrentNode();if(a){return a}else{return{id:-1}}};ui.ajax=function(b,c,a){if(!b||b.length===0){return}$.ajax({url:b,dataType:"JSON",data:"GET",success:function(f,d,e){if(c){c(f.data)}},error:function(f,d,e){if(e){e(f,d)}}})};ui.cookie={};ui.cookie.get=function(b){var e=encodeURIComponent(b)+"=",a=document.cookie.indexOf(e),d=null,c;if(a>-1){c=document.cookie.indexOf(";",a);if(c===-1){c=document.cookie.length}d=decodeURIComponent(document.cookie.substring(a+e.length,c))}return d};ui.cookie.set=function(b,e,a,g,d,f){var c=encodeURIComponent(b)+"="+encodeURIComponent(e);if(a instanceof Date){c+="; expires="+a.toGMTString()}if(g){c+="; path="+g}if(d){c+="; domain="+d}if(f){c+="; secure"}document.cookie=c};ui.cookie.unset=function(a,d,b,c){ui.cookie.set(a,"",new Date(0),d,b,c)};ui.ls={};ui.ls.item=function(){var a,b;if(!window.localStorage||arguments.length===0){return}if(arguments.length===1){a=arguments[0];b=localStorage.getItem(a);return b}else{if(arguments.length>=2){a=arguments[0];b=arguments[1];localStorage.setItem(a,b);return b}}};ui.controller={};ui.PathTestRegex=/^http[s]?:\/\//;ui.controller.Router=Backbone.Router.extend({el_topMenu:undefined,regex:/appId=(\d+)&subId=(\d+)/,routes:{"*path":"goToPath"},initialize:function(a){this.el_topMenu=a},goToPath:function(e){var a=this,d,b,c;if(e===""){return}if(a.regex.test(e)){d=RegExp.$1;b=RegExp.$2;setTimeout(function(){ui.TopMenu.setSelectedMenu(d,b)},500)}if(!ui.PathTestRegex.test(e)){e="/"+e}top.frames["main-frame"].location.href=e}});ui.model={};ui.model.Menu=Backbone.Model.extend({subMenu:{},initialize:function(b){var a=b.menuList,c,d,e;if(a){for(c=0,d=a.length;c<d;c++){e=a[c].id.toString();this.subMenu[e]=a[c]}}else{this.set("menuList",[])}},isRelativeTree:function(a){return this.subMenu[a].relationTree}});ui.model.MenuList=Backbone.Collection.extend({model:ui.model.Menu,save:function(a){ui.ajax(a+this.pluck("id").join(","))}});ui.view={};ui.view.DraggableMenuView=Backbone.View.extend({tagName:"li",className:"draggable",template:_.template($("#tpl-draggableMenuItem").html()),render:function(){var b=this,a;$(this.el).html(this.template(this.model.toJSON()));a=this.$(".sub-menu");this.$(".detail").hover(function(c){var e=$(this.parentNode).position().top,d=c.target.parentNode;if(e>200){b.$(".sub-menu").css({bottom:"28px"})}else{b.$(".sub-menu").css({top:"28px"})}$(d).removeAttr("style");a.toggleClass("hide")},function(c){a.toggleClass("hide");b.$(".sub-menu").removeAttr("style")});$(this.el).attr("data-uid",this.model.get("id"));return this}});ui.view.TopMenuView=Backbone.View.extend({tagName:"li",className:"top-menu-btn",template:_.template($("#tpl-topNavMenuItem").html()),subMenuHeight:0,events:{"click a":"_showInFrame"},render:function(){var a=this,d=a.model.get("menuList"),b,c;a.model.view=a;$(a.el).html(a.template(a.model.toJSON()));$(a.el).hover(function(f){var e=$(document).width(),h=$(f.target).position().left,g=a.$(".popup-panel"),i=f.target;if($(i).hasClass("top-menu-btn")){setTimeout(function(){a._showSubMenu(h)},80)}else{if(i.tagName==="SPAN"){setTimeout(function(){a._showSubMenu(h)},80)}}},function(e){setTimeout(function(){a.$(".popup-panel").addClass("hide")},100)});$(a.el).attr("data-uid",a.model.get("id"));a.model.view=a;return a},totalWidth:function(){return $(this.el).outerWidth()},unselect:function(){var a=this;a.$("span").removeClass("selected");a.$("a").removeClass("selected")},selected:function(b){var a=this;a.$("span").addClass("selected");a.$("a[data-uid='"+b+"']").addClass("selected");ui.view.TopMenuView.CurrentMenu=this;return this},_showSubMenu:function(d){var c=this,a=$(document).width(),b=c.$(".popup-panel");if(d<(a/2)){b.css({left:d,right:"auto"})}else{b.css({right:a-(d+100),left:"auto"})}b.removeClass("hide")},_showInFrame:function(h){var f=h.target,b=f.getAttribute("href"),d=f.getAttribute("data-uid"),g=b.indexOf("#"),c=b.substring(g+1),e=ui.getNodeId()===-1?1:ui.getNodeId(),i=this.model.get("id"),a="appId="+i+"&subId="+d;if(ui.view.TopMenuView.CurrentMenu){ui.view.TopMenuView.CurrentMenu.unselect()}if(this.model.isRelativeTree(d)){if(ui.ArgumentTestRegex.test(b)){b=b+"&nodeId="+e+"&nodeid="+e}else{b=b+"?nodeId="+e+"&nodeid="+e}}if(ui.ArgumentTestRegex.test(b)){b=b+"&"+a}else{b=b+"?"+a}location.href=b;return false}},{CurrentMenu:undefined});ui.view.CustomizeMenuPanel=Backbone.View.extend({el:$("#js-customize-menu-panel"),menuPanel:this.$("div.container"),el_close:this.$("#js-customize-menu-panel-close"),el_selectedList:this.$(".selected-area"),el_unselectedList:this.$(".unselected-area"),el_showBtn:this.$("#js-show-btn"),el_hideBtn:this.$("#js-hide-btn"),el_tips:this.$(".tips"),otherMenus:new ui.model.MenuList(),isRemove:false,menus:undefined,events:{"click .close-btn":"_saveUserApp"},initialize:function(d){var j=this,b=j.el,e=j.menuPanel,c=$(document),g=c.width(),i=c.height(),f=(i-400)/2,a=(g-600)/2,h=j.otherMenus;$("div.container").draggable({cursor:"move",cancel:".draggable-area"});j.menus=d;$(e[0]).css({top:f,left:a});d.each(function(l,k){j._addSelectedMenu(l,d,{index:k})});j.otherMenus.on("add",j._addUnselectedMenu,j);ui.ajax("/platform/AppController/getAllApp",function(k){h.add(k.otherApp)});$(j.el_selectedList).sortable({connectWith:".unselected-area",opacity:0.7,cancel:".tips",items:".draggable",handle:".draggable-title",receive:function(m,p){var q=$(p.item[0]).attr("data-uid"),o=j.otherMenus.get(q),l=j.el_selectedList.children(),n=l.index(p.item[0]),k;if($(this).children().length===2){k=$("li",this).first().detach();k.appendTo(this)}d.add(o.attributes,{at:n});j.otherMenus.remove(o)},stop:function(k,o){if(j.isRemove){j.isRemove=false;return}else{var p=$(o.item[0]).attr("data-uid"),l=j.el_selectedList.children(),m=l.index(o.item[0]),n=d.get(p);d.remove(n);d.add(n.attributes,{at:m})}},remove:function(k,l){var n=$(l.item[0]).attr("data-uid"),m=d.get(n);d.remove(m);j.otherMenus.add(m.attributes,{silent:true});j.isRemove=true}});$(j.el_unselectedList).sortable({connectWith:".selected-area",handle:".draggable-title",opacity:0.7})},_addSelectedMenu:function(d,e,c){var a=new ui.view.DraggableMenuView({model:d}),b=this.el_selectedList.children(),f=b.length;if(b[c.index]){this.el_selectedList[0].insertBefore(a.render().el,b[c.index])}else{this.el_selectedList[0].appendChild(a.render().el)}},_addUnselectedMenu:function(c,e,b){var a=new ui.view.DraggableMenuView({model:c}),d=this.el_unselectedList.children(),f=d.length;if(d[b.index]){this.el_unselectedList[0].insertBefore(a.render().el,d[b.index])}else{this.el_unselectedList[0].appendChild(a.render().el)}},_saveUserApp:function(){$(this.el).addClass("hide");this.menus.save("/platform/UserViewController/saveUserView?appIds=")},adjustDisplayPosition:function(a,e){var c=this,d=(e-400-200)/2,b=(a-600)/2;$(c.menuPanel[0]).css({top:d,left:b})}});ui.view.AccountMenuView=Backbone.View.extend({el:$("#js-account-menu"),events:{"click a":"_showInFrame"},_showInFrame:function(a){var c=a.target,b=c.getAttribute("href"),d=$("#js-tree-container");if(!d.hasClass("hide")){d.addClass("hide");ui.util.hideServiceTreeLoading()}$(this.el).toggleClass("hide");if(b.indexOf("http://")===-1){location.href=b}else{if($(c).hasClass("logout")){location.href=b}else{window.open(b)}}return false},show:function(){$(this.el).removeClass("hide")},hide:function(){$(this.el).addClass("hide")}});ui.view.TopMenuPanel=Backbone.View.extend({el:$("#header"),el_serviceTree:$("#js-tree-container"),el_topMenu:$("#js-top-nav-menu"),el_shiftBtn:$("#js-shiftBtn"),el_leftBtn:$("#js-left-btn"),el_rightBtn:$("#js-right-btn"),el_treePath:$("#js-currentTree"),leftBound:0,rightBound:0,displayMenuWidth:0,totalMenuWidth:0,displayableItemNumber:0,isShiftBtnShow:false,customizeMenuPanel:undefined,accountMenu:new ui.view.AccountMenuView(),resizing:false,menus:new ui.model.MenuList(),router:undefined,menuViewMap:{},events:{"click #js-account-btn":"_clear","click #js-service-tree-button":"_toggleServiceTree","click #js-left-btn":"_shiftLeft","click #js-right-btn":"_shiftRight","click #js-more-menu":"_showCustomizeMenuPanel",selectstart:function(a){a.preventDefault()},click:"_hideEverything"},initialize:function(){var c=$(document),d=c.width(),a=this,b=ui.cookie.get("USER_NOAH");if(b){a.$("#js-account-btn").text(b)}else{location.href="http://tc-oped-dev03.tc.baidu.com:8287/olive/index.php?r=Passport/Logging/Index&url=http://tc-oped-dev03.tc.baidu.com:8090/watermelon/templates/"}a._setdisplayMenuWidth(d);a.menus.on("add",this._addTopMenu,this);a.menus.on("remove",this._removeTopMenu,this);a._getUserCustomizedMenu(function(e){a.menus.add(e)});a._addResponseToResize();a.router=new ui.controller.Router(a.el_topMenu)},setTreePath:function(c){var a=this,b=c&&c.length;if(b>24){a.el_treePath.text(".."+c.substring(c.length-24))}else{a.el_treePath.text(c)}a.el_treePath.attr("title",c)},setSelectedMenu:function(c,b){var a=this;a.menuViewMap[c].selected(b)},_getUserCustomizedMenu:function(a){ui.ajax("/platform/AppController/getAppByUser",a)},_adjustShiftBtnDisplay:function(){var a=this,c=a.el_topMenu.children(),b=c.size();if(a.leftBound===0){a.el_leftBtn.addClass("disable")}else{a.el_leftBtn.removeClass("disable")}if(a.rightBound===b){a.el_rightBtn.addClass("disable")}else{a.el_rightBtn.removeClass("disable")}},_adjustMenuItemDisplay:function(d,f){var a=this,b,c=a.leftBound,e=a.rightBound;for(b=0;b<f;b++){if(b<c||b>=e){$(d[b]).addClass("hide")}else{$(d[b]).removeClass("hide")}}},_adjustMenuDisplay:function(){var a=this,c=a.el_topMenu.children(),b=c.size();if(b<=a.displayableItemNumber){a.el_shiftBtn.addClass("hide");a.$(".top-menu-btn").removeClass("hide")}else{a.el_shiftBtn.removeClass("hide");if(a.rightBound===b){a.leftBound=a.rightBound-a.displayableItemNumber}else{if(b-a.rightBound<a.displayableItemNumber-(a.rightBound-a.leftBound)){a.rightBound=b;a.leftBound=b-a.displayableItemNumber}else{a.rightBound=a.leftBound+a.displayableItemNumber}}a._adjustShiftBtnDisplay();a._adjustMenuItemDisplay(c,b)}},_addResponseToResize:function(){var a=this,b=$(document);$(window).resize(function(){a.resizing=true;setTimeout(function(){if(a.resizing){var c=b.width();a.resizing=false;a._setdisplayMenuWidth(c);a._adjustMenuDisplay();if(a.customizeMenuPanel){a.customizeMenuPanel.adjustDisplayPosition(c,b.height())}}},500)})},_setdisplayMenuWidth:function(c){var a=this,b=c-460;a.el_topMenu.css("width",b);a.displayMenuWidth=b;a.displayableItemNumber=Math.floor(a.displayMenuWidth/112);return b},_addTopMenu:function(f,g,e){var c=this,b=new ui.view.TopMenuView({model:f}),a=this.el_topMenu.children(),d=a.length;if(a[e.index]){this.el_topMenu[0].insertBefore(b.render().el,a[e.index])}else{this.el_topMenu[0].appendChild(b.render().el)}c.menuViewMap[f.get("id")]=b;if(e.index<c.leftBound){$(b.el).addClass("hide")}c._adjustMenuDisplay()},_removeTopMenu:function(e,f,d){var b=this,a=this.el_topMenu[0].children,c=this.rightBound-this.leftBound;$(a[this.rightBound]).removeClass("hide");this.el_topMenu[0].removeChild(a[d.index]);b.menuViewMap[e.get("id")]=null;if(d.index<b.leftBound){b.leftBound--}b._adjustMenuDisplay()},_shiftLeft:function(b){var a=this.el_topMenu.children();if($(b.target).hasClass("disable")){return}$(a[--this.leftBound]).removeClass("hide");$(a[--this.rightBound]).addClass("hide");this.el_rightBtn.removeClass("disable");if(this.leftBound===0){this.el_leftBtn.addClass("disable")}},_shiftRight:function(b){var c=this.menus.size(),a=this.el_topMenu.children();if($(b.target).hasClass("disable")){return}$(a[this.rightBound++]).removeClass("hide");$(a[this.leftBound++]).addClass("hide");this.el_leftBtn.removeClass("disable");if(this.rightBound===c){this.el_rightBtn.addClass("disable")}},_showCustomizeMenuPanel:function(){var a=this;if(!a.customizeMenuPanel){a.customizeMenuPanel=new ui.view.CustomizeMenuPanel(this.menus)}$(a.customizeMenuPanel.el).removeClass("hide")},_clear:function(){var a=this;$(a.accountMenu.el).toggleClass("hide");if(!$(a.el_serviceTree).hasClass("hide")){$(a.el_serviceTree).addClass("hide");ui.util.hideServiceTreeLoading()}},_toggleServiceTree:function(){var a=this;if($(a.el_serviceTree).hasClass("hide")){$(a.el_serviceTree).removeClass("hide")}else{$(a.el_serviceTree).addClass("hide");ui.util.hideServiceTreeLoading()}return false},_hideEverything:function(a){var b=this,c=a.target.id;if(c!=="js-account-btn"){b.accountMenu.hide()}}});var controll=new (function(){var a=this;a.showCnt=ui.showCnt;a.getNode=ui.getNodeId;a.getNodeAttributes=ui.getNodeAttributes;window.frames.rightFrame=window.frames["main-frame"]})();(function(){ui.TopMenu=new ui.view.TopMenuPanel();Backbone.history.start({pushState:false})})();