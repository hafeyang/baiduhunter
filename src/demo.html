{/include file="site/header.html"/}
<title>备份变更的首页,选择向导信息</title>
<link rel="stylesheet" type="text/css" href="/olive/css/table.css" />
<style>
table.grid{
    width:100%; *width:98%;
    font-size:13px; 
    background-color:#ccc;
}
table.grid th{
    background:url(/olive/images/grid_head.gif) repeat-x scroll;
    height:26px;
    text-align:center;
    font-weight:normal;
    white-space:nowrap;
    word-break:keep-all;
}
table.grid td{
    padding:2px 0px 2px 4px;
    background-color:#fff;
    text-align:left;
    height:26px;
}
table.grid .item{width:130px;}
.cntTitle{background:#D2D2A6; font-weight:bolder; padding:2px 10px; margin:8px 0 0;}
form{padding:0;margin:0;}
</style>
</head>

<body>
{/include file="site/helpcenter.html"/}
<div style='text-align:right;'><input type='button' value='查看源协议信息' onclick="window.parent.viewCoreData({/$data.id/})"></div>
<form id='form1' name='form1' method='post' action='index.php?r=ChangeBackup/Guide'>
<div class='cntTitle'>选择需要变更的基本信息</div>
<input type='hidden' name='id' value='{/$data.id/}'>
<table class="grid">
<tr><td width="200">需要变更的数据分类</td><td>数据保留份数或时间信息<input type="hidden" name="isCount" value="1">
<!--input type='checkbox' id='isDown' name='isDown' value='1' onclick='changeShow();'>数据下线>
<input type='checkbox' id='isCount' name='isCount' value='1' onclick='changeShow();'>数据保留份数或时间信息
<input type='checkbox' id='isSource' name='isSource' value='1' onclick='changeShow();'>数据源的机器和目录信息-->
</td></tr>
<tbody id='isForever0'>
<tr>
<td>是否要修改为永久备份</td>
<td>
<input type='radio' id='isForever1' name='isForever' value='0' onclick='changeShow();' checked>否
<input type='radio' id='isForever2' name='isForever' value='1' onclick='changeShow();'>是
</td></tr>
</tbody>
</table>
<div class='cntTitle'>流程参与人信息</div>
<table class="grid">
<tr><td width="200">创建人</td><td><input type='text' name='select[CREATOR]' id='select[CREATOR]' value='{/$data.creator/}' size='24' readOnly></td></tr>
<tr><td>数据源维护人</td><td><input type='text' name='select[OP]' id='select[OP]' value='{/$data.op/}' size='24' onblur="checkEmpty(this,false);"></td></tr>
<tr><td>DMOP操作人</td><td><input type='text' name='select[DMOP_OPERATOR]' id='select[DMOP_OPERATOR]' size='24' value='{/$data.dmopOperator/}' onblur="checkEmpty(this,false);"></td></tr>
<tr id='leader1'><td>创建人经理</td><td><input type='text' name='select[DEPART_LEADER]' id='select[DEPART_LEADER]' size='24' value='{/$data.departLeader/}' onblur='checkEmpty(this,false);'></td></tr>
<tr id='leader2'><td>DMOP备份负责人</td><td><input type='text' name='select[DMOP_LEADER]' id='select[DMOP_LEADER]' size='24' value='{/$data.dmopLeader/}' onblur="checkEmpty(this,false);"></td></tr>
<tr id='boss1' style='display:none'><td>创建人总监</td><td><input type='text' name='select[DEPART_BOSS]' id='select[DEPART_BOSS]' size='24' value='{/$data.departBoss/}' onblur="checkEmpty(this,false);"></td></tr>
<tr id='boss2' style='display:none'><td>OP总监</td><td><input type='text' name='select[OP_BOSS]' id='select[OP_BOSS]' size='24' value='{/$data.opBoss/}' onblur="checkEmpty(this,false);"></td></tr>
</table>
<!--input type='button' name='submit1' value='下一步' onclick='submitRequest();' /-->
<!--p align='left'>
    <input type='button' value='查看源协议信息' onclick="var coreData = document.getElementById('coreData'); if (coreData.height == 500){ coreData.height=0;} else {coreData.height=500;}">
    
</p-->
<!--iframe id='coreData' src='index.php?r=common/coreData&id={/$data.id/}&hasUrl=0' width='80%' height='0' frameborder='no' border='0' marginwidth='0' marginheight='0' allowtransparency='yes'></iframe-->
</form>

</body>
<script type="text/javascript" src="/ui/scripts/suggest.js"> </script>
<script type="text/javascript" src='/jquery/js/jquery-1.3.2.min.js'></script>
<script src='./js/adapter/ext/ext-base.js'></script>
<script src='./js/ext-all-3.0.0.js'></script>
<script language='javascript'>
//提交前验证是否所有的输入都正确
function submitRequest(){
    //验证所有人员是否已经全部填写
    var selectArr = new Array('select[OP]', 'select[DMOP_OPERATOR]', 'select[DEPART_LEADER]', 'select[DMOP_LEADER]', 'select[DEPART_BOSS]', 'select[OP_BOSS]');     //要验证的id或者name
    var result = checkEmptyByIds(selectArr, true);
    if (result != true) {
        return false;
    }
    //验证所有的人员输入是否正确的人名
    var opStr = '';
    for (var i=0; i<selectArr.length ;i++ ){
        var tmp = document.getElementById(selectArr[i]);
        if (tmp == null){
            continue;
        }
        var str = tmp.value;
        if (str.indexOf(' ') != -1) {
            window.parent.popLayer.alert('流程参与人填写错误','WARNING');
            tmp.focus();
            return;
        }
        //检查用分号分隔的用户名是否有重复
        var tmpArr = str.split(';');
        for (var j=0;j<tmpArr.length ;j++ ){
            for (var k = j+1; k<tmpArr.length ;k++ ){
                if (tmpArr[j] == tmpArr[k]) {
                    window.parent.popLayer.alert('同一角色不能有重复的用户','WARNING');
                    tmp.focus();
                    return;
                }
            }
        }
        opStr = opStr + tmp.value + ';';
    }
    $.ajax({
        type:"POST",
        url:"/mizar/index.php?r=User/CheckUserName",
        dataType:"json",
        data:{"username":opStr},
        success:function(json){
            if(json.success){
                //判断是否下线,如果下线需要用户确认一下
                document.getElementById('form1').submit();
                return;
            }else{
                window.parent.popLayer.alert(json.message,"WARNING");
                return false;
            }
        },
        error:function(){
            window.parent.popLayer.alert("验证用户名正确性失败,请再次提交","ERROR");
            return false;
        }
    });
}
//对外层窗口按钮进行操作
window.parent.document.getElementById("btnChangeOk").value = "下一步";
window.parent.popLayer.changeBackupOk = submitRequest;
//根据当前页面上选择的要变更那些类型的信息,计算所有的框是否该显示
function changeShow(){
    var boss1 = document.getElementById('boss1');
    var boss2 = document.getElementById('boss2');

    //要改变份数,判断是否永久保存
    if (document.getElementById('isForever2').checked == true){
        boss1.style.display='';
        boss2.style.display='';
    }else {
        boss1.style.display='none';
        boss2.style.display='none';
    }
  
}

//注册suggest接口
var selectArr = new Array('select[OP]', 'select[DMOP_OPERATOR]', 'select[DEPART_LEADER]', 'select[DMOP_LEADER]', 'select[DEPART_BOSS]', 'select[OP_BOSS]');
suggestByIds(selectArr);

</script>
